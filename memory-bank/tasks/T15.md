# T15: Physics Engine Architecture Migration
*Last Updated: 2025-09-03 21:35:30 IST*

**Description**: Migrate existing physics engine to new architecture combining system-based separation of concerns, hybrid strategy preservation, and phase-based execution model
**Status**: ðŸ”„ IN PROGRESS
**Current Phase**: Runtime Engine Toggle Implementation - COMPLETED
**Priority**: HIGH
**Started**: 2025-08-28
**Last Active**: 2025-09-03 21:35:30 IST
**Dependencies**: T5c, T12, T14

## Completion Criteria
- Two-phase execution model (preUpdate/integrate) implemented
- Centralized TimeManager and CoordinateSystem classes created
- Strategy pattern enhanced with phase-based interfaces
- All existing functionality preserved during migration
- Performance benchmarks show no regression
- Feature flag system enables rollback capability

## Related Files
- `frontend/src/physics/RandomWalkSimulator.ts`
- `frontend/src/physics/ParticleManager.ts`
- `frontend/src/physics/strategies/`
- `frontend/src/physics/interfaces/RandomWalkStrategy.ts`
- `frontend/src/physics/core/GlobalTime.ts`
- `frontend/src/physics/utils/density.ts`
- `frontend/src/physics/utils/ThermalVelocities.ts`
- `frontend/src/physics/utils/InitDistributions.ts`
- `memory-bank/implementation-details/physics-engine-rewrite-final.md`
- `memory-bank/implementation-details/physics-engine-rewrite-implementation.md`
- `memory-bank/implementation-details/random-walk-simulator-refactor.md`

## Related PRs
- PR #1: feat(physics): scaffold new engine core (no behavior change)
  https://github.com/space-cadet/qc-diffusion-code/pull/1
- PR #3: feat(physics): T15 - Phase 3 time unification with GlobalTime; restore CTRWStrategy2D; thermal velocities
  https://github.com/space-cadet/qc-diffusion-code/pull/3

## Progress
1. âœ… Architecture analysis completed
2. âœ… Phase 1: Core Infrastructure (TimeManager, CoordinateSystem, PhysicsStrategy, StrategyOrchestrator, PhysicsEngine scaffolding, feature flag)
3. âœ… Phase 2: Strategy Adaptation (LegacyStrategyAdapter, feature-flagged engine init in RandomWalkSimulator)
4. âœ… Phase 3: Time/Logging Unification (GlobalTime utilities, thermal velocities, unified simTime()/simDt())
5. âœ… Phase 3.5: Ballistic Strategy Rollout (BallisticStrategy interface migration, constructor fixes, integration tests)
6. âœ… Phase 4: Issue Resolution & Testing (velocity property fix, import cleanup, debug logging)
7. ðŸ”„ Phase 4.5: Code Organization (extract utilities from RandomWalkSimulator, improve modularity)
8. â¬œ Phase 5: Boundary System Extraction (dedicated boundary phase)
9. â¬œ Phase 6: Incremental Subsystem Enablement (ballistic â†’ CTRW â†’ collisions)

## Context
Migration plan synthesizes best elements from three architectural approaches: Claude4 system-based design, DeepSeek hybrid strategy preservation, and GPT5 phase-based execution. Key improvements include centralized time management, two-phase particle updates, and separation of collision detection from position integration. Phase 3 integrated thermal velocity system with Maxwell-Boltzmann distribution and momentum conservation.

## Implementation Phases
- **Phase 1-2**: Foundation and strategy adaptation (4 sessions)
- **Phase 3-4**: Integration and refactoring (3 sessions)  
- **Phase 5**: Polish and validation (1 session)

## Progress Log
- 2025-08-28 19:13:51 IST â€” Step 1 scaffolding added (TimeManager, CoordinateSystem, PhysicsStrategy, Orchestrator, PhysicsEngine, Vite flag); builds clean.
- 2025-08-28 19:17:49 IST â€” Phase 1 complete. Memory bank updated for merge readiness.
- 2025-08-28 20:27:23 IST â€” Phase 2 complete: LegacyStrategyAdapter created, feature-flagged engine init in RandomWalkSimulator, performance timing marks added. No behavior change, builds clean. Ready for PR.
- 2025-08-28 21:28:20 IST â€” Phase 3 complete: GlobalTime utilities implemented, all strategies unified with simTime()/simDt(), thermal velocity integration with Maxwell-Boltzmann distribution, PhysicsEngine timeStep aligned to 0.01. No remaining Date.now() usage in physics directory.
- 2025-08-28 23:10:43 IST â€” Phase 3.5 complete: BallisticStrategy migrated from PhysicsStrategy to RandomWalkStrategy interface, RandomWalkSimulator constructor fixes with proper CoordinateSystem/ParticleManager instantiation, integration tests updated, missing getter methods added. All modified files use consistent constructor signatures.
- 2025-08-29 15:23:43 IST â€” Phase 4 complete: Critical velocity property mismatch resolved (vx/vy vs x/y), LegacyBallisticStrategy import cleanup, step() method logic fixed, extensive debug logging added. Root cause identified: thermal velocities used {vx,vy} but ParticleManager read {x,y}. Physics simulation now functional with visible particle movement.
- 2025-08-30 00:35:27 IST â€” Phase 4.5 progress: Refactored RandomWalkSimulator.ts to improve code organization and modularity. Extracted density profile and field computation to utils/density.ts; extracted thermal velocity generation to utils/ThermalVelocities.ts; extracted initial position sampling to utils/InitDistributions.ts. Fixed lint error in generateThermalVelocities by defining thermalSpeed constant. Preserved existing behavior and APIs while improving maintainability.
- 2025-08-31 02:43:12 IST â€” Phase 4.6 complete: Animation loop architecture fixed to follow migration plan two-phase design. Fixed useParticlesLoader state path bug causing continuous physics stepping when tab visible. Implemented proper Phase A (physics controlled by simulation state) and Phase B (rendering controlled by visibility). Added conditional logging to eliminate console flooding. Fixed ReferenceError in ParticleInitializer. Physics now steps only when simulation running, not continuously when tab visible.
- 2025-08-31 19:10:02 IST â€” Phase 4.7 complete: Boundary integration finalized. Updated StrategyFactory to pass BoundaryConfig to new BallisticStrategy for consistency with legacy strategies. Added lightweight boundary update path in RandomWalkSimulator using PhysicsEngine.updateConfiguration() to avoid engine rebuilds when only boundary conditions change. Boundary enforcement now centralized via BoundaryPhase in new engine architecture.
- 2025-08-31 22:41:47 IST â€” Phase 4.8 complete: dt propagation and UI fixes. Fixed dt parameter not being passed from UI to RandomWalkSimulator constructor and updateParameters calls. Fixed LogNumberSlider responsiveness issues: corrected log mapping without +1 hacks, removed forced rounding for continuous sliders, added discrete mode for integer-only outputs (enabled for particle count). Fixed useParticlesLoader container lifecycle to prevent premature destruction. Particles now visible in simulation with proper dt control from UI.
- 2025-09-03 21:35:30 IST â€” Phase 5 Runtime Engine Toggle: Implemented UI toggle button in page header for switching between legacy and new physics engines. Added useNewEngine state to app store with persistence, modified RandomWalkSimulator constructor to accept engine flag parameter, updated dependency array to recreate simulator when engine changes. Added comprehensive architecture analysis and execution flow documentation to implementation-details/random-walk-engine-plan.md. Runtime engine selection now fully functional with visual feedback.

## Risk Mitigation
- Feature flags for immediate rollback
- Parallel implementation maintains existing functionality
- Incremental testing after each phase
- Performance benchmarks prevent regressions